const t='function'==typeof globalThis.$&&void 0!==globalThis.SillyTavern,e={皇帝:{觉醒度:12,当前幕:'第一幕'},李克:{警惕度:35,内心想法:'这小皇帝今晚倒是格外安分……不过最近他偶尔会问起朝政，需要多加留意。'},柳妃:{母爱残存:42,内心想法:'儿啊……你又瘦了。可是今晚李克还要来……我无法拒绝他。'},林婉茹:{忠诚动摇:28,内心想法:'那春药的配方……如果陛下知道真相，他会恨我吗？'},苏锦儿:{可策反度:15,内心想法:'几秒钟的玩具罢了。不过李克大人今晚会来"善后"吧……身体已经开始期待了。'},沈清芷:{复仇决心:88,身体抗药:45,内心想法:'总有一天，我会亲手割下那个男人的头颅……可是这该死的身体，又在渴望他了。'},赵嫣:{暗恋强度:72,压抑临界:78,内心想法:'陛下今日整理寝具时留下的气味……不、不可以想这些。我是尚宫局的人。'}},n=[{name:'李克',role:'丞相',color:'rgba(180,80,70,0.75)',stats:[{label:'警惕度',path:'/李克/警惕度'}],thoughtPath:'/李克/内心想法'},{name:'柳妃',role:'太后',color:'rgba(190,170,90,0.7)',stats:[{label:'母爱残存',path:'/柳妃/母爱残存'}],thoughtPath:'/柳妃/内心想法'},{name:'林婉茹',role:'御医',color:'rgba(100,170,130,0.7)',stats:[{label:'忠诚动摇',path:'/林婉茹/忠诚动摇'}],thoughtPath:'/林婉茹/内心想法'},{name:'苏锦儿',role:'御女营花魁',color:'rgba(200,100,110,0.7)',stats:[{label:'可策反度',path:'/苏锦儿/可策反度'}],thoughtPath:'/苏锦儿/内心想法'},{name:'沈清芷',role:'将门之女',color:'rgba(90,130,180,0.7)',stats:[{label:'复仇决心',path:'/沈清芷/复仇决心'},{label:'身体抗药',path:'/沈清芷/身体抗药'}],thoughtPath:'/沈清芷/内心想法'},{name:'赵嫣',role:'尚宫局主事',color:'rgba(150,110,180,0.7)',stats:[{label:'暗恋强度',path:'/赵嫣/暗恋强度'},{label:'压抑临界',path:'/赵嫣/压抑临界'}],thoughtPath:'/赵嫣/内心想法'}],o={第一幕:'第一幕·沉沦',第二幕:'第二幕·裂痕',第三幕:'第三幕·暗流',第四幕:'第四幕·破局'};function s(n){try{const o=n.split('/').filter(Boolean);let s;if(t)try{const t=Mvu.getMvuData({type:'chat'});s=t?.stat_data}catch{s=getAllVariables()}else s=e;for(const t of o)s=s?.[t];return s}catch{return}}function a(t){const e=s('/皇帝/觉醒度')??0,n=s('/皇帝/当前幕')??'第一幕',a=o[n]||n,c=document.getElementById('act-tag'),l=document.getElementById('awakening-value'),i=document.getElementById('awakening-dots');if(c&&(c.textContent=a),l&&(l.textContent=String(e)),i){const t=Math.min(4,Math.floor(e/25));i.querySelectorAll('.dot').forEach((e,n)=>{e.classList.toggle('on',n<t)})}if(t){const e=document.getElementById('time-tag'),n=document.getElementById('weather-tag'),o=document.getElementById('location-tag');e&&(e.textContent=t.time||'未知'),n&&(n.textContent=t.weather||''),o&&(o.textContent=t.location||'')}}let c=0;function l(t){c=(c+t+n.length)%n.length,r()}function i(t,e,n){const o=Math.min(100,e);return`<div class="s-bar">\n        <span class="s-bar-lb">${t}</span>\n        <div class="s-bar-track">\n            <div class="s-bar-fill${o>=100?' full':''}" style="width:${o}%;--sc:${n}"></div>\n        </div>\n        <span class="s-bar-val" style="color:${n}">${e}</span>\n    </div>`}function r(){const t=document.getElementById('char-status');if(!t)return;const e=n[c];if(!e)return void(t.innerHTML='');const o=document.getElementById('char-name'),a=document.getElementById('char-role'),l=document.getElementById('char-idx');o&&(o.textContent=e.name),a&&(a.textContent=e.role),l&&(l.textContent=`${c+1}/${n.length}`);let r=`<div class="s-seal">${e.name[0]}</div>`,d='';for(const t of e.stats){const n=s(t.path)??0;d+=i(t.label,n,e.color)}const m=s(e.thoughtPath)||'';r+=`<div class="s-info">${d}${`<div class="s-thought"><em>内心 </em>${m?'「'+m+'」':'<span style="opacity:.3">暂无</span>'}</div>`}</div>`,t.innerHTML=r}const d=[];function m(t,e){d.push({time:t,content:e}),function(){const t=document.getElementById('chronicle-list');if(0===d.length)return void(t.innerHTML='<div class="chronicle-entry"><div class="chronicle-time">承平三年</div>故事尚未展开……</div>');t.innerHTML=d.map(t=>`\n    <div class="chronicle-entry">\n      <div class="chronicle-time">${t.time}</div>\n      ${t.content}\n    </div>\n  `).join('')}()}let u=-1;function h(){try{const t=SillyTavern.chat;if(!t||0===t.length)return;if(t.length===u)return;u=t.length;const e=t[t.length-1];if(!e||e.is_user)return;const n=e.mes||'';if(!n)return;document.getElementById('loading-indicator')?.classList.remove('show');const o=function(t){const e=t.match(/☞(.+?)☜/);if(!e)return null;const n=e[1].split('-').map(t=>t.trim());return{year:n[0]||'',date:n[1]||'',weather:n[2]||'',time:n[3]||'',location:n[4]||'',atmosphere:n[5]||''}}(n);a(o);const s=function(t){const e=t.match(/<maintext>([\s\S]*?)<\/maintext>/);if(e)return e[1].trim();let n=t;return n=n.replace(/☞[\s\S]*?☜\s*/,''),n=n.replace(/<UpdateVariable>[\s\S]*$/,''),n=n.replace(/<StatusPlaceHolderImpl\/?>[\s]*$/,''),n=n.replace(/<sum>[\s\S]*?<\/sum>/g,''),n.trim()}(n);s&&function(t){const e=document.getElementById('story-text'),n=t.split('\n').filter(t=>t.trim());e.innerHTML=n.map(t=>`<p>${t}</p>`).join('');const o=document.getElementById('text-area');o.scrollTop=o.scrollHeight}(s);const c=function(t){const e=t.match(/<sum>([\s\S]*?)<\/sum>/);return e?e[1].trim():''}(n);if(c&&o){m(`${o.year} ${o.date} ${o.time}`,c)}r()}catch(t){}}const g='[皇帝卡]';function p(t,e,n,o,s,a){return{id:crypto.randomUUID?.()??Math.random().toString(36).slice(2),script_name:`${g} ${t}`,enabled:!0,scope:'character',find_regex:e,replace_string:n,trim_strings:'',source:{user_input:!1,ai_output:!1,slash_command:!1,world_info:!1,...o},destination:{display:!1,prompt:!1,...s},run_on_edit:!0,min_depth:a??null,max_depth:null}}function y(){if(function(){const t=document.getElementById('start-screen'),e=document.getElementById('game-container');t.addEventListener('click',()=>{t.classList.add('fade-out'),setTimeout(()=>{t.style.display='none',e.classList.add('active')},800);try{document.documentElement.requestFullscreen?.()}catch{}})}(),function(){const t=document.getElementById('settings-btn'),e=document.getElementById('settings-panel');t.addEventListener('click',t=>{t.stopPropagation(),e.classList.toggle('show')}),document.addEventListener('click',()=>e.classList.remove('show')),document.getElementById('btn-chronicle')?.addEventListener('click',()=>{e.classList.remove('show'),document.getElementById('chronicle-modal')?.classList.add('show')}),document.getElementById('btn-fullscreen')?.addEventListener('click',()=>{e.classList.remove('show'),document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen?.()}),document.getElementById('chronicle-close')?.addEventListener('click',()=>{document.getElementById('chronicle-modal')?.classList.remove('show')}),document.getElementById('chronicle-modal')?.addEventListener('click',t=>{t.target===t.currentTarget&&t.currentTarget.classList.remove('show')})}(),function(){const t=document.getElementById('btn-prev'),e=document.getElementById('btn-next');t?.addEventListener('click',()=>l(-1)),e?.addEventListener('click',()=>l(1)),document.getElementById('btn-toggle-sidebar')?.addEventListener('click',()=>{const t=document.getElementById('status-panel');t&&(t.style.display='none'===t.style.display?'':'none'),document.getElementById('settings-panel')?.classList.remove('show')});const n=document.getElementById('mobile-status-toggle'),o=document.getElementById('status-panel'),s=document.getElementById('mobile-overlay');n?.addEventListener('click',()=>{o?.classList.toggle('mobile-open'),s?.classList.toggle('show')}),s?.addEventListener('click',()=>{o?.classList.remove('mobile-open'),s?.classList.remove('show')});let a=0;o?.addEventListener('touchstart',t=>{a=t.touches[0].clientX}),o?.addEventListener('touchend',t=>{const e=t.changedTouches[0].clientX-a;Math.abs(e)>50&&l(e<0?1:-1)})}(),function(){const t=document.getElementById('user-input'),e=document.getElementById('send-btn'),n=document.getElementById('loading-indicator');t.addEventListener('input',()=>{t.style.height='auto',t.style.height=Math.min(t.scrollHeight,80)+'px'});const o=()=>{const e=t.value.trim();if(e){t.value='',t.style.height='auto',n.classList.add('show');try{const t=document.querySelector('#send_textarea');t&&(t.value=e,t.dispatchEvent(new Event('input',{bubbles:!0})));const n=document.querySelector('#send_but');n&&n.click()}catch(t){console.error('发送失败:',t),n.classList.remove('show')}}};e.addEventListener('click',o),t.addEventListener('keydown',t=>{'Enter'!==t.key||t.shiftKey||(t.preventDefault(),o())})}(),t){const t=document.createElement('style');t.textContent='\n            #chat .mes { display: none !important; }\n            #chat { background: transparent !important; }\n        ',document.head.appendChild(t),async function(){try{await updateTavernRegexesWith(t=>{const e=t.filter(t=>!t.script_name.startsWith(g));return e.push(p('隐藏时间栏','☞[\\s\\S]*?☜','',{ai_output:!0},{display:!0}),p('隐藏变量更新','<UpdateVariable>[\\s\\S]*?</UpdateVariable>','',{ai_output:!0},{display:!0}),p('变量深度限制','<UpdateVariable>[\\s\\S]*?</UpdateVariable>','',{ai_output:!0},{prompt:!0},6),p('隐藏占位符','<StatusPlaceHolderImpl/?>','',{ai_output:!0},{prompt:!0})),e},{scope:'character'})}catch(t){console.warn('[皇帝卡] 正则注入失败:',t)}}();try{(SillyTavern.chat?.length??0)>1&&(document.getElementById('start-screen').style.display='none',document.getElementById('game-container').classList.add('active'),h())}catch{}setInterval(h,1e3)}a(),r()}if(t){let t=0;const e=60,n=()=>{document.getElementById('start-screen')?(console.log('[皇帝卡] DOM 元素已就绪，开始初始化'),y()):t<e?(t++,setTimeout(n,500)):console.warn('[皇帝卡] 等待 DOM 元素超时（30秒），HTML 可能未通过正则注入')};$(()=>n()),$(window).on('pagehide',()=>{})}else'loading'===document.readyState?document.addEventListener('DOMContentLoaded',y):y();