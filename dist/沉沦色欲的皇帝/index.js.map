{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/沉沦色欲的皇帝/index.ts"],"sourcesContent":["/**\r\n * 沉沦色欲的皇帝 — 同层前端卡入口\r\n * \r\n * 核心模块：\r\n * - StartScreen: 开始屏幕\r\n * - TimeBar: 时间栏解析渲染\r\n * - MainTextArea: 正文显示\r\n * - StatusPanel: 角色状态栏\r\n * - InputBar: 用户输入发送\r\n * - VariableSync: MVU 变量读写\r\n * - ChronicleModal: 编年史/读档\r\n */\r\n\r\n// ============================================================\r\n// 环境检测\r\n// ============================================================\r\n\r\n/** 检测是否在酒馆环境中（jQuery 和 SillyTavern 都存在则为酒馆） */\r\nconst isInTavern = typeof (globalThis as any).$ === 'function'\r\n    && typeof (globalThis as any).SillyTavern !== 'undefined';\r\n\r\n/** 独立预览时的 mock 数据 */\r\nconst MOCK_VARS: Record<string, any> = {\r\n    '皇帝': { '觉醒度': 12, '当前幕': '第一幕' },\r\n    '李克': { '警惕度': 35, '内心想法': '这小皇帝今晚倒是格外安分……不过最近他偶尔会问起朝政，需要多加留意。' },\r\n    '柳妃': { '母爱残存': 42, '内心想法': '儿啊……你又瘦了。可是今晚李克还要来……我无法拒绝他。' },\r\n    '林婉茹': { '忠诚动摇': 28, '内心想法': '那春药的配方……如果陛下知道真相，他会恨我吗？' },\r\n    '苏锦儿': { '可策反度': 15, '内心想法': '几秒钟的玩具罢了。不过李克大人今晚会来\"善后\"吧……身体已经开始期待了。' },\r\n    '沈清芷': { '复仇决心': 88, '身体抗药': 45, '内心想法': '总有一天，我会亲手割下那个男人的头颅……可是这该死的身体，又在渴望他了。' },\r\n    '赵嫣': { '暗恋强度': 72, '压抑临界': 78, '内心想法': '陛下今日整理寝具时留下的气味……不、不可以想这些。我是尚宫局的人。' },\r\n};\r\n\r\n// ============================================================\r\n// 角色数据定义\r\n// ============================================================\r\ninterface GameCharacter {\r\n    name: string;\r\n    role: string;\r\n    color: string;\r\n    stats: { label: string; path: string }[];\r\n    thoughtPath: string;\r\n}\r\n\r\nconst CHARACTERS: GameCharacter[] = [\r\n    {\r\n        name: '李克', role: '丞相', color: 'rgba(180,80,70,0.75)',\r\n        stats: [{ label: '警惕度', path: '/李克/警惕度' }],\r\n        thoughtPath: '/李克/内心想法',\r\n    },\r\n    {\r\n        name: '柳妃', role: '太后', color: 'rgba(190,170,90,0.7)',\r\n        stats: [{ label: '母爱残存', path: '/柳妃/母爱残存' }],\r\n        thoughtPath: '/柳妃/内心想法',\r\n    },\r\n    {\r\n        name: '林婉茹', role: '御医', color: 'rgba(100,170,130,0.7)',\r\n        stats: [{ label: '忠诚动摇', path: '/林婉茹/忠诚动摇' }],\r\n        thoughtPath: '/林婉茹/内心想法',\r\n    },\r\n    {\r\n        name: '苏锦儿', role: '御女营花魁', color: 'rgba(200,100,110,0.7)',\r\n        stats: [{ label: '可策反度', path: '/苏锦儿/可策反度' }],\r\n        thoughtPath: '/苏锦儿/内心想法',\r\n    },\r\n    {\r\n        name: '沈清芷', role: '将门之女', color: 'rgba(90,130,180,0.7)',\r\n        stats: [\r\n            { label: '复仇决心', path: '/沈清芷/复仇决心' },\r\n            { label: '身体抗药', path: '/沈清芷/身体抗药' },\r\n        ],\r\n        thoughtPath: '/沈清芷/内心想法',\r\n    },\r\n    {\r\n        name: '赵嫣', role: '尚宫局主事', color: 'rgba(150,110,180,0.7)',\r\n        stats: [\r\n            { label: '暗恋强度', path: '/赵嫣/暗恋强度' },\r\n            { label: '压抑临界', path: '/赵嫣/压抑临界' },\r\n        ],\r\n        thoughtPath: '/赵嫣/内心想法',\r\n    },\r\n];\r\n\r\n// 幕标识映射\r\nconst ACT_NAMES: Record<string, string> = {\r\n    '第一幕': '第一幕·沉沦',\r\n    '第二幕': '第二幕·裂痕',\r\n    '第三幕': '第三幕·暗流',\r\n    '第四幕': '第四幕·破局',\r\n};\r\n\r\n// ============================================================\r\n// 工具函数\r\n// ============================================================\r\n\r\n/** 从变量路径读取值（兼容酒馆/独立环境） */\r\nfunction readVar(path: string): any {\r\n    try {\r\n        const keys = path.split('/').filter(Boolean);\r\n        let val: any;\r\n        if (isInTavern) {\r\n            // 酒馆环境：优先从 MVU stat_data 读取\r\n            try {\r\n                const mvuData = Mvu.getMvuData({ type: 'chat' });\r\n                val = mvuData?.stat_data;\r\n            } catch {\r\n                val = getAllVariables();\r\n            }\r\n        } else {\r\n            // 独立环境：用 mock 数据\r\n            val = MOCK_VARS;\r\n        }\r\n        for (const k of keys) {\r\n            val = val?.[k];\r\n        }\r\n        return val;\r\n    } catch {\r\n        return undefined;\r\n    }\r\n}\r\n\r\n/** 解析 LLM 消息中的 ☞时间栏☜ */\r\nfunction parseTimeBar(text: string): { year: string; date: string; weather: string; time: string; location: string; atmosphere: string } | null {\r\n    const match = text.match(/☞(.+?)☜/);\r\n    if (!match) return null;\r\n    const parts = match[1].split('-').map(s => s.trim());\r\n    return {\r\n        year: parts[0] || '',\r\n        date: parts[1] || '',\r\n        weather: parts[2] || '',\r\n        time: parts[3] || '',\r\n        location: parts[4] || '',\r\n        atmosphere: parts[5] || '',\r\n    };\r\n}\r\n\r\n/** 提取正文内容（支持两种模式） */\r\nfunction parseMainText(text: string): string {\r\n    // 模式1：标签模式 <maintext>...</maintext>\r\n    const tagged = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/);\r\n    if (tagged) return tagged[1].trim();\r\n\r\n    // 模式2：自动提取 — ☞...☜ 之后到 <UpdateVariable> 之前\r\n    let content = text;\r\n    content = content.replace(/☞[\\s\\S]*?☜\\s*/, '');            // 移除时间栏\r\n    content = content.replace(/<UpdateVariable>[\\s\\S]*$/, '');   // 移除变量更新及之后\r\n    content = content.replace(/<StatusPlaceHolderImpl\\/?>[\\s]*$/, ''); // 移除占位符\r\n    content = content.replace(/<sum>[\\s\\S]*?<\\/sum>/g, '');      // 移除小总结\r\n    return content.trim();\r\n}\r\n\r\n/** 提取 <sum> 内容 */\r\nfunction parseSummary(text: string): string {\r\n    const match = text.match(/<sum>([\\s\\S]*?)<\\/sum>/);\r\n    return match ? match[1].trim() : '';\r\n}\r\n\r\n/** 提取 <UpdateVariable> 中的 JSONPatch */\r\nfunction parseVariableUpdate(text: string): any[] {\r\n    const match = text.match(/<JSONPatch>([\\s\\S]*?)<\\/JSONPatch>/);\r\n    if (!match) return [];\r\n    try {\r\n        return JSON.parse(match[1].trim());\r\n    } catch {\r\n        return [];\r\n    }\r\n}\r\n\r\n// ============================================================\r\n// 模块：开始屏幕\r\n// ============================================================\r\nfunction initStartScreen() {\r\n    const screen = document.getElementById('start-screen')!;\r\n    const container = document.getElementById('game-container')!;\r\n\r\n    screen.addEventListener('click', () => {\r\n        screen.classList.add('fade-out');\r\n        setTimeout(() => {\r\n            screen.style.display = 'none';\r\n            container.classList.add('active');\r\n        }, 800);\r\n        // 尝试全屏\r\n        try { document.documentElement.requestFullscreen?.(); } catch { }\r\n    });\r\n}\r\n\r\n// ============================================================\r\n// 模块：设置面板\r\n// ============================================================\r\nfunction initSettingsPanel() {\r\n    const btn = document.getElementById('settings-btn')!;\r\n    const panel = document.getElementById('settings-panel')!;\r\n\r\n    btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        panel.classList.toggle('show');\r\n    });\r\n\r\n    document.addEventListener('click', () => panel.classList.remove('show'));\r\n\r\n    // 编年史按钮\r\n    document.getElementById('btn-chronicle')?.addEventListener('click', () => {\r\n        panel.classList.remove('show');\r\n        document.getElementById('chronicle-modal')?.classList.add('show');\r\n    });\r\n\r\n    // 全屏切换\r\n    document.getElementById('btn-fullscreen')?.addEventListener('click', () => {\r\n        panel.classList.remove('show');\r\n        if (document.fullscreenElement) {\r\n            document.exitFullscreen();\r\n        } else {\r\n            document.documentElement.requestFullscreen?.();\r\n        }\r\n    });\r\n\r\n    // 关闭编年史\r\n    document.getElementById('chronicle-close')?.addEventListener('click', () => {\r\n        document.getElementById('chronicle-modal')?.classList.remove('show');\r\n    });\r\n    document.getElementById('chronicle-modal')?.addEventListener('click', (e) => {\r\n        if (e.target === e.currentTarget) {\r\n            (e.currentTarget as HTMLElement).classList.remove('show');\r\n        }\r\n    });\r\n}\r\n\r\n// ============================================================\r\n// 模块：时间栏渲染\r\n// ============================================================\r\nfunction renderTimeBar(timeData?: ReturnType<typeof parseTimeBar>) {\r\n    // 从变量读取幕信息\r\n    const awakening = readVar('/皇帝/觉醒度') ?? 0;\r\n    const actNum = readVar('/皇帝/当前幕') ?? '第一幕';\r\n    const actName = ACT_NAMES[actNum] || actNum;\r\n\r\n    const actTag = document.getElementById('act-tag');\r\n    const awakeningValue = document.getElementById('awakening-value');\r\n    const awakeningDots = document.getElementById('awakening-dots');\r\n\r\n    if (actTag) actTag.textContent = actName;\r\n    if (awakeningValue) awakeningValue.textContent = String(awakening);\r\n\r\n    // 渲染觉醒度进度点（每25%一个亮点，共4个）\r\n    if (awakeningDots) {\r\n        const litCount = Math.min(4, Math.floor(awakening / 25));\r\n        const dots = awakeningDots.querySelectorAll('.dot');\r\n        dots.forEach((dot, i) => {\r\n            dot.classList.toggle('on', i < litCount);\r\n        });\r\n    }\r\n\r\n    // 从时间栏数据渲染\r\n    if (timeData) {\r\n        const timeTag = document.getElementById('time-tag');\r\n        const weatherTag = document.getElementById('weather-tag');\r\n        const locationTag = document.getElementById('location-tag');\r\n        if (timeTag) timeTag.textContent = timeData.time || '未知';\r\n        if (weatherTag) weatherTag.textContent = timeData.weather || '';\r\n        if (locationTag) locationTag.textContent = timeData.location || '';\r\n    }\r\n}\r\n\r\n// ============================================================\r\n// 模块：状态栏\r\n// ============================================================\r\nlet currentCharIndex = 0;\r\n\r\nfunction initStatusPanel() {\r\n    // 左右翻页导航\r\n    const prevBtn = document.getElementById('btn-prev');\r\n    const nextBtn = document.getElementById('btn-next');\r\n    prevBtn?.addEventListener('click', () => navigateChar(-1));\r\n    nextBtn?.addEventListener('click', () => navigateChar(1));\r\n\r\n    // 状态栏切换（桌面端设置菜单 + topbar 按钮）\r\n    document.getElementById('btn-toggle-sidebar')?.addEventListener('click', () => {\r\n        const panel = document.getElementById('status-panel');\r\n        if (panel) panel.style.display = panel.style.display === 'none' ? '' : 'none';\r\n        document.getElementById('settings-panel')?.classList.remove('show');\r\n    });\r\n\r\n    // 移动端切换\r\n    const toggle = document.getElementById('mobile-status-toggle');\r\n    const panel = document.getElementById('status-panel');\r\n    const overlay = document.getElementById('mobile-overlay');\r\n    toggle?.addEventListener('click', () => {\r\n        panel?.classList.toggle('mobile-open');\r\n        overlay?.classList.toggle('show');\r\n    });\r\n    overlay?.addEventListener('click', () => {\r\n        panel?.classList.remove('mobile-open');\r\n        overlay?.classList.remove('show');\r\n    });\r\n\r\n    // 触摸滑动切换角色\r\n    let touchStartX = 0;\r\n    panel?.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });\r\n    panel?.addEventListener('touchend', (e) => {\r\n        const dx = e.changedTouches[0].clientX - touchStartX;\r\n        if (Math.abs(dx) > 50) navigateChar(dx < 0 ? 1 : -1);\r\n    });\r\n}\r\n\r\n/** 导航到上一个/下一个角色 */\r\nfunction navigateChar(direction: number) {\r\n    currentCharIndex = (currentCharIndex + direction + CHARACTERS.length) % CHARACTERS.length;\r\n    renderCharStatus();\r\n}\r\n\r\n/** 生成水渍进度条 HTML */\r\nfunction renderBar(label: string, value: number, color: string): string {\r\n    const pct = Math.min(100, value);\r\n    const fullClass = pct >= 100 ? ' full' : '';\r\n    return `<div class=\"s-bar\">\r\n        <span class=\"s-bar-lb\">${label}</span>\r\n        <div class=\"s-bar-track\">\r\n            <div class=\"s-bar-fill${fullClass}\" style=\"width:${pct}%;--sc:${color}\"></div>\r\n        </div>\r\n        <span class=\"s-bar-val\" style=\"color:${color}\">${value}</span>\r\n    </div>`;\r\n}\r\n\r\nfunction renderCharStatus() {\r\n    const container = document.getElementById('char-status');\r\n    if (!container) return;\r\n    const charData = CHARACTERS[currentCharIndex];\r\n    if (!charData) { container.innerHTML = ''; return; }\r\n\r\n    // 更新导航信息\r\n    const nameEl = document.getElementById('char-name');\r\n    const roleEl = document.getElementById('char-role');\r\n    const idxEl = document.getElementById('char-idx');\r\n    if (nameEl) nameEl.textContent = charData.name;\r\n    if (roleEl) roleEl.textContent = charData.role;\r\n    if (idxEl) idxEl.textContent = `${currentCharIndex + 1}/${CHARACTERS.length}`;\r\n\r\n    // 印章\r\n    let html = `<div class=\"s-seal\">${charData.name[0]}</div>`;\r\n\r\n    // 属性条\r\n    let barsHtml = '';\r\n    for (const stat of charData.stats) {\r\n        const value = readVar(stat.path) ?? 0;\r\n        barsHtml += renderBar(stat.label, value, charData.color);\r\n    }\r\n\r\n    // 内心独白\r\n    const thought = readVar(charData.thoughtPath) || '';\r\n    const thoughtHtml = `<div class=\"s-thought\"><em>内心 </em>${thought ? '「' + thought + '」' : '<span style=\"opacity:.3\">暂无</span>'}</div>`;\r\n\r\n    html += `<div class=\"s-info\">${barsHtml}${thoughtHtml}</div>`;\r\n    container.innerHTML = html;\r\n}\r\n\r\n// ============================================================\r\n// 模块：正文渲染\r\n// ============================================================\r\nfunction renderMainText(text: string) {\r\n    const container = document.getElementById('story-text')!;\r\n    // 将文本按段落分割并渲染\r\n    const paragraphs = text.split('\\n').filter(p => p.trim());\r\n    container.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');\r\n\r\n    // 滚动到底部\r\n    const textArea = document.getElementById('text-area')!;\r\n    textArea.scrollTop = textArea.scrollHeight;\r\n}\r\n\r\n// ============================================================\r\n// 模块：编年史\r\n// ============================================================\r\nconst chronicles: { time: string; content: string }[] = [];\r\n\r\nfunction addChronicle(time: string, content: string) {\r\n    chronicles.push({ time, content });\r\n    renderChronicles();\r\n}\r\n\r\nfunction renderChronicles() {\r\n    const list = document.getElementById('chronicle-list')!;\r\n    if (chronicles.length === 0) {\r\n        list.innerHTML = '<div class=\"chronicle-entry\"><div class=\"chronicle-time\">承平三年</div>故事尚未展开……</div>';\r\n        return;\r\n    }\r\n    list.innerHTML = chronicles.map(c => `\r\n    <div class=\"chronicle-entry\">\r\n      <div class=\"chronicle-time\">${c.time}</div>\r\n      ${c.content}\r\n    </div>\r\n  `).join('');\r\n}\r\n\r\n// ============================================================\r\n// 模块：输入栏\r\n// ============================================================\r\nfunction initInputBar() {\r\n    const input = document.getElementById('user-input') as HTMLTextAreaElement;\r\n    const sendBtn = document.getElementById('send-btn')!;\r\n    const loading = document.getElementById('loading-indicator')!;\r\n\r\n    // 自动调整高度\r\n    input.addEventListener('input', () => {\r\n        input.style.height = 'auto';\r\n        input.style.height = Math.min(input.scrollHeight, 80) + 'px';\r\n    });\r\n\r\n    // 发送\r\n    const doSend = () => {\r\n        const text = input.value.trim();\r\n        if (!text) return;\r\n        input.value = '';\r\n        input.style.height = 'auto';\r\n        loading.classList.add('show');\r\n\r\n        // 调用酒馆 API 发送消息\r\n        try {\r\n            // 将用户输入写到酒馆输入框并触发发送\r\n            const tavernInput = document.querySelector('#send_textarea') as HTMLTextAreaElement;\r\n            if (tavernInput) {\r\n                tavernInput.value = text;\r\n                tavernInput.dispatchEvent(new Event('input', { bubbles: true }));\r\n            }\r\n            const sendButton = document.querySelector('#send_but');\r\n            if (sendButton) {\r\n                (sendButton as HTMLElement).click();\r\n            }\r\n        } catch (e) {\r\n            console.error('发送失败:', e);\r\n            loading.classList.remove('show');\r\n        }\r\n    };\r\n\r\n    sendBtn.addEventListener('click', doSend);\r\n    input.addEventListener('keydown', (e) => {\r\n        if (e.key === 'Enter' && !e.shiftKey) {\r\n            e.preventDefault();\r\n            doSend();\r\n        }\r\n    });\r\n}\r\n\r\n// ============================================================\r\n// 模块：消息解析与监听\r\n// ============================================================\r\nlet lastProcessedMessageCount = -1;\r\n\r\nfunction processLatestMessage() {\r\n    try {\r\n        // 通过 SillyTavern.chat 读取最新消息\r\n        const chat = SillyTavern.chat;\r\n        if (!chat || chat.length === 0) return;\r\n        if (chat.length === lastProcessedMessageCount) return;\r\n        lastProcessedMessageCount = chat.length;\r\n\r\n        // 获取最新的 AI 消息\r\n        const latestMsg = chat[chat.length - 1];\r\n        if (!latestMsg || latestMsg.is_user) return;\r\n\r\n        const msgText = latestMsg.mes || '';\r\n        if (!msgText) return;\r\n\r\n        // 隐藏加载指示器\r\n        document.getElementById('loading-indicator')?.classList.remove('show');\r\n\r\n        // 解析时间栏\r\n        const timeData = parseTimeBar(msgText);\r\n        renderTimeBar(timeData);\r\n\r\n        // 解析正文\r\n        const mainText = parseMainText(msgText);\r\n        if (mainText) {\r\n            renderMainText(mainText);\r\n        }\r\n\r\n        // 解析小总结 → 编年史\r\n        const summary = parseSummary(msgText);\r\n        if (summary && timeData) {\r\n            const timeStr = `${timeData.year} ${timeData.date} ${timeData.time}`;\r\n            addChronicle(timeStr, summary);\r\n        }\r\n\r\n        // 变量更新由 MVU 框架自动处理，无需手动解析\r\n\r\n        // 刷新状态栏\r\n        renderCharStatus();\r\n\r\n    } catch (e) {\r\n        // 初始化阶段可能无消息，静默忽略\r\n    }\r\n}\r\n\r\n// 变量更新由 MVU 框架和酒馆助手脚本自动处理\r\n// 前端只需从 Mvu.getMvuData() 读取最新状态即可\r\n\r\n// ============================================================\r\n// 阶段3B：正则自动注入\r\n// ============================================================\r\nconst REGEX_PREFIX = '[皇帝卡]';\r\n\r\n/** 创建一条 TavernRegex 对象 */\r\nfunction createRegex(\r\n    name: string,\r\n    findRegex: string,\r\n    replaceStr: string,\r\n    source: Partial<TavernRegex['source']>,\r\n    destination: Partial<TavernRegex['destination']>,\r\n    minDepth?: number,\r\n): TavernRegex {\r\n    return {\r\n        id: crypto.randomUUID?.() ?? Math.random().toString(36).slice(2),\r\n        script_name: `${REGEX_PREFIX} ${name}`,\r\n        enabled: true,\r\n        scope: 'character',\r\n        find_regex: findRegex,\r\n        replace_string: replaceStr,\r\n        trim_strings: '',\r\n        source: {\r\n            user_input: false,\r\n            ai_output: false,\r\n            slash_command: false,\r\n            world_info: false,\r\n            ...source,\r\n        },\r\n        destination: {\r\n            display: false,\r\n            prompt: false,\r\n            ...destination,\r\n        },\r\n        run_on_edit: true,\r\n        min_depth: minDepth ?? null,\r\n        max_depth: null,\r\n    };\r\n}\r\n\r\n/** 自动注入/更新角色卡正则 */\r\nasync function setupRegexScripts() {\r\n    try {\r\n        await updateTavernRegexesWith(regexes => {\r\n            // 移除旧的同名正则\r\n            const filtered = regexes.filter(r => !r.script_name.startsWith(REGEX_PREFIX));\r\n            // 添加新正则\r\n            filtered.push(\r\n                createRegex('隐藏时间栏', '☞[\\\\s\\\\S]*?☜', '',\r\n                    { ai_output: true }, { display: true }),\r\n                createRegex('隐藏变量更新', '<UpdateVariable>[\\\\s\\\\S]*?</UpdateVariable>', '',\r\n                    { ai_output: true }, { display: true }),\r\n                createRegex('变量深度限制', '<UpdateVariable>[\\\\s\\\\S]*?</UpdateVariable>', '',\r\n                    { ai_output: true }, { prompt: true }, 6),\r\n                createRegex('隐藏占位符', '<StatusPlaceHolderImpl/?>', '',\r\n                    { ai_output: true }, { prompt: true }),\r\n            );\r\n            return filtered;\r\n        }, { scope: 'character' });\r\n    } catch (e) {\r\n        console.warn('[皇帝卡] 正则注入失败:', e);\r\n    }\r\n}\r\n\r\n\r\n\r\n// ============================================================\r\n// 初始化\r\n// ============================================================\r\nfunction init() {\r\n    initStartScreen();\r\n    initSettingsPanel();\r\n    initStatusPanel();\r\n    initInputBar();\r\n\r\n    if (isInTavern) {\r\n        // 阶段3A：隐藏酒馆原生消息楼层（同层界面已替代）\r\n        const hideStyle = document.createElement('style');\r\n        hideStyle.textContent = `\r\n            #chat .mes { display: none !important; }\r\n            #chat { background: transparent !important; }\r\n        `;\r\n        document.head.appendChild(hideStyle);\r\n\r\n        // 阶段3B：自动注入正则脚本\r\n        setupRegexScripts();\r\n\r\n        // 酒馆环境：检测是否已有消息（非首次打开）\r\n        try {\r\n            const chatLen = SillyTavern.chat?.length ?? 0;\r\n            if (chatLen > 1) {\r\n                document.getElementById('start-screen')!.style.display = 'none';\r\n                document.getElementById('game-container')!.classList.add('active');\r\n                processLatestMessage();\r\n            }\r\n        } catch { }\r\n\r\n        // 监听新消息（轮询方式）\r\n        setInterval(processLatestMessage, 1000);\r\n    }\r\n\r\n    // 初始渲染\r\n    renderTimeBar();\r\n    renderCharStatus();\r\n}\r\n\r\n// 兼容初始化：酒馆中用 $()，独立浏览器用 DOMContentLoaded\r\nif (isInTavern) {\r\n    $(() => init());\r\n    $(window).on('pagehide', () => { /* 清理工作 */ });\r\n} else {\r\n    if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', init);\r\n    } else {\r\n        init();\r\n    }\r\n}\r\n"],"names":["isInTavern","globalThis","$","SillyTavern","MOCK_VARS","CHARACTERS","name","role","color","stats","label","path","thoughtPath","ACT_NAMES","readVar","keys","split","filter","Boolean","val","mvuData","Mvu","getMvuData","type","stat_data","getAllVariables","k","renderTimeBar","timeData","awakening","actNum","actName","actTag","document","getElementById","awakeningValue","awakeningDots","textContent","String","litCount","Math","min","floor","querySelectorAll","forEach","dot","i","classList","toggle","timeTag","weatherTag","locationTag","time","weather","location","currentCharIndex","navigateChar","direction","length","renderCharStatus","renderBar","value","pct","container","charData","innerHTML","nameEl","roleEl","idxEl","html","barsHtml","stat","thought","chronicles","addChronicle","content","push","list","map","c","join","renderChronicles","lastProcessedMessageCount","processLatestMessage","chat","latestMsg","is_user","msgText","mes","remove","text","match","parts","s","trim","year","date","atmosphere","parseTimeBar","mainText","tagged","replace","parseMainText","paragraphs","p","textArea","scrollTop","scrollHeight","renderMainText","summary","parseSummary","e","REGEX_PREFIX","createRegex","findRegex","replaceStr","source","destination","minDepth","id","crypto","randomUUID","random","toString","slice","script_name","enabled","scope","find_regex","replace_string","trim_strings","user_input","ai_output","slash_command","world_info","display","prompt","run_on_edit","min_depth","max_depth","init","screen","addEventListener","add","setTimeout","style","documentElement","requestFullscreen","initStartScreen","btn","panel","stopPropagation","fullscreenElement","exitFullscreen","target","currentTarget","initSettingsPanel","prevBtn","nextBtn","overlay","touchStartX","touches","clientX","dx","changedTouches","abs","initStatusPanel","input","sendBtn","loading","height","doSend","tavernInput","querySelector","dispatchEvent","Event","bubbles","sendButton","click","console","error","key","shiftKey","preventDefault","initInputBar","hideStyle","createElement","head","appendChild","async","updateTavernRegexesWith","regexes","filtered","r","startsWith","warn","setupRegexScripts","setInterval","window","on","readyState"],"sourceRoot":""}